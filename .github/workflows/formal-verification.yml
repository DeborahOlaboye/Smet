name: Formal Verification

on:
  push:
    paths:
      - 'contract/**'
  pull_request:
    paths:
      - 'contract/**'

jobs:
  foundry-prove:
    name: Foundry tests & (optional) prove
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Foundry
        run: |
          curl -L https://foundry.paradigm.xyz | bash
          source $HOME/.bashrc || true
          foundryup
      - name: Run forge tests
        working-directory: contract
        run: |
          forge test --root .
      - name: Attempt forge prove (optional)
        if: ${{ always() }}
        working-directory: contract
        run: |
          # Attempt to run `forge prove` (requires z3); allow failure but surface output
          if command -v z3 >/dev/null 2>&1; then
            forge prove --root . || true
          else
            echo "z3 not found; skipping forge prove"
          fi

  echidna:
    name: Echidna fuzzing
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run Echidna (Docker)
        run: |
          docker run --rm -v $GITHUB_WORKSPACE:/project -w /project --entrypoint echidna-test trailofbits/echidna:latest \
            contract/contracts/test/EchidnaSmetGold.sol --contract EchidnaSmetGold --solc-version 0.8.26 || true
      - name: Upload Echidna results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: echidna-report
          path: echidna-report || ''
